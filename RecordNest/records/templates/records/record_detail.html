{% extends 'main/base.html' %}
{% load custom_filters %}

{% block title %}{{ record.title }} | RecordNest{% endblock %}

{% block content %}

{% load static %}
<link rel="stylesheet" href="{% static 'css/record.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">


<div class="record-container">
    <h1>{{ record.title }}</h1>

    <div class="record-header">
        {% if record.images %}
        <div class="image-carousel">
            <button class="carousel-btn prev-btn" onclick="changeSlide(-1)"><i class="fas fa-chevron-left"></i></button>
            <img id="carousel-img" loading ="lazy" src="{{ record.images.0 }}" alt="Portada del disco">
            <button class="carousel-btn next-btn" onclick="changeSlide(1)"><i class="fas fa-chevron-right"></i></button>
        </div>
        {% endif %}
        

        <div class="record-info">
            <p><strong>Artistas:</strong>
                {% for artist in record.artists %}
                    <a href="{% url 'artists:artist_detail' %}?id={{ artist.id }}" class="artist-link">
                        {{ artist.name }}
                    </a>{% if not forloop.last %}, {% endif %}
                {% empty %}
                    Sin artista
                {% endfor %}
            </p>
            <p><strong>A침o:</strong> {{ record.year }}</p>
            <p><strong>Lanzado:</strong> {{ record.released }}</p>
            <p><strong>Notas:</strong> {{ record.notes }}</p>
            <p><strong>C칩digo de Barras:</strong> {{ record.barcode|default:"No disponible" }}</p>
            <p><strong>G칠neros:</strong> {{ record.genres }}</p>
            <p><strong>Estilos:</strong> {{ record.styles }}</p>
            <p><strong>Sello:</strong> {{ record.labels }}</p>
            <p><strong>Formato:</strong> {{ record.formats }}</p>
        </div>

    </div>

    <div class="button-container">
        <form action="{% url 'add_to_collection' %}" method="post">
            {% csrf_token %}
            <input type="hidden" name="title" value="{{ record.title }}">
            
            {{ record.artists|json_script:"artists-data" }}
            <input type="hidden" name="artists" id="artists-json-input">

            <input type="hidden" name="year" value="{{ record.year }}">
            <input type="hidden" name="cover_image" value="{{ record.images.0|default:'' }}">
            <input type="hidden" name="released" value="{{ record.released }}">
            <input type="hidden" name="notes" value="{{ record.notes }}">
            <input type="hidden" name="barcode" value="{{ record.barcode }}">
            <input type="hidden" name="tags" value="{{ record.tags }}">
            <input type="hidden" name="genres" value="{{ record.genres }}">
            <input type="hidden" name="styles" value="{{ record.styles }}">
            <input type="hidden" name="labels" value="{{ record.labels }}">
            <input type="hidden" name="formats" value="{{ record.formats }}">
            
            {{ record.tracklist|json_script:"tracklist-data" }}
            <input type="hidden" name="tracklist_json" id="tracklist-json-input">

            {% if is_in_collection %}
                <button type="submit" class="collection-btn" disabled>
                    <i class="fa-slab-press fa-regular fa-plus"></i> Ya est치 en tu colecci칩n
                </button>
            {% else %}
                <button type="submit" class="collection-btn">
                    <i class="fa-slab-press fa-regular fa-plus"></i> A침adir a mi colecci칩n
                </button>
            {% endif %}
        </form>

        <script>
            console.log("Est치 en la colecci칩n:", "{{ is_in_collection }}");
        </script>

        {% if is_in_wishlist %}
            <button class="wishlist-btn" disabled>
                <i class="fas fa-heart"></i> Ya est치 en tu wishlist
            </button>
        {% else %}
            {% if record.master_id %}
                <form action="{% url 'add_to_wishlist' record.master_id %}" method="post">
                    {% csrf_token %}
                    <button type="submit" class="wishlist-btn">
                        <i class="fas fa-heart"></i> A침adir a la wishlist
                    </button>
                </form>
            {% elif record.release_id %}
                <form action="{% url 'add_to_wishlist' record.release_id %}" method="post">
                    {% csrf_token %}
                    <button type="submit" class="wishlist-btn">
                        <i class="fas fa-heart"></i> A침adir a la wishlist
                    </button>
                </form>
            {% else %}
                <p>Este disco no tiene un identificador disponible para a침adir a la wishlist.</p>
            {% endif %}
        {% endif %}
    </div>



    <h3>Tracklist</h3>
    <div class="spotify-tracklist">
        {% for track in record.tracklist %}
            {% if record.tracklist %}
                <div class="spotify-track">
                    <div class="track-left">
                        <div class="track-number">
                            <span>{{ track.position }}</span>
                        </div>
                        <div class="track-meta">
                            <div class="track-title">{{ track.title }}</div>
                            {% if track.deezer_artists %}
                                <div class="track-artist">{{ track.deezer_artists|join:", " }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="track-right">
                        <span class="track-duration">{{ track.duration }}</span>
                    
                        {% if track.id %}
                            <div class="custom-player" data-id="{{ track.id }}">
                                <button class="play-btn"><i class="fas fa-play"></i></button>
                                <div class="progress-bar"><div class="progress"></div></div>
                            </div>
                            <a href="{{ track.deezer_link }}" target="_blank" class="deezer-btn">Deezer</a>
                        {% else %}
                            <span class="no-preview">游댆</span>
                        {% endif %}
                    </div>
                </div>
            {% else %}
                    <p class="no-tracks">Este disco no tiene tracklist disponible.</p>
            {% endif %}
        {% endfor %}
    </div>
    <span id="masterId" style="display: none;">{{ record.master_id }}</span>
    
    <h3>Versiones disponibles</h3>

    <div id="versions-container" class="versions-grid">
        {% for version in record.versions %}
            <a href="{% url 'record_detail' version.id %}" class="version-card-link">
                <div class="version-card">
                    <div class="version-card-content">
                        <p><strong>A침o:</strong> {{ version.year }}</p>
                        <p><strong>Pa칤s:</strong> {{ version.country }}</p>
                        <p><strong>Formato:</strong> {{ version.format }}</p>
                        <p><strong>Sello:</strong> {{ version.label }}</p>
                        <p><strong>{{ version.barcode_type }}:</strong> {{ version.barcode }}</p>
                    </div>
                </div>
            </a>
        {% endfor %}
    </div>
    <div id="masterId" style="display: none;">{{ record.master_id }}</div>
    
    <button id="load-more" class="load-more-btn">Cargar m치s versiones</button>
    <div id="loading-spinner" style="display: none; margin-top: 1rem; text-align: center;">
        <div class="spinner"></div>
    </div>
    
    

    <script>
        const images = {{ record.images|safe }};
        let currentIndex = 0;
    
        function changeSlide(direction) {
            currentIndex = (currentIndex + direction + images.length) % images.length;
            document.getElementById('carousel-img').src = images[currentIndex];
        }
    </script>
        
             
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // Pasar artistas en JSON
    const artists = JSON.parse(document.getElementById("artists-data").textContent);
    document.getElementById("artists-json-input").value = JSON.stringify(artists);

    // Pasar tracklist en JSON
    const tracklist = JSON.parse(document.getElementById("tracklist-data").textContent);
    document.getElementById("tracklist-json-input").value = JSON.stringify(tracklist);
});
</script>

<script>
document.querySelectorAll(".custom-player").forEach(player => {
    const playBtn = player.querySelector(".play-btn");
    const icon = playBtn.querySelector("i");
    const progress = player.querySelector(".progress");
    let audio = null;
    let isPlaying = false;

    playBtn.addEventListener("click", async () => {
        if (!audio) {
            const id = player.dataset.id;
            const response = await fetch(`/search/ajax/preview/${id}/`);
            const data = await response.json();

            if (!data.preview) {
                icon.classList.remove("fa-play");
                icon.classList.add("fa-ban");
                return;
            }

            audio = new Audio(data.preview);
            audio.preload = "none";
            player.appendChild(audio);
            setupAudioEvents(audio, icon, progress);
        }

        document.querySelectorAll("audio").forEach(a => a.pause());
        if (isPlaying) {
            audio.pause();
        } else {
            audio.play();
        }
    });

    function setupAudioEvents(audio, icon, progress) {
        audio.addEventListener("play", () => {
            isPlaying = true;
            icon.classList.replace("fa-play", "fa-pause");
        });

        audio.addEventListener("pause", () => {
            isPlaying = false;
            icon.classList.replace("fa-pause", "fa-play");
        });

        audio.addEventListener("timeupdate", () => {
            const percentage = (audio.currentTime / audio.duration) * 100;
            progress.style.width = percentage + "%";
        });

        audio.addEventListener("ended", () => {
            isPlaying = false;
            icon.classList.replace("fa-pause", "fa-play");
            progress.style.width = "0%";
        });
    }
});
</script>

<script id="masterId" type="application/json">{{ record.master_id }}</script>

{{ record.master_id|json_script:"masterId" }}
<script>
    const masterId = JSON.parse(document.getElementById("masterId").textContent);
    const container = document.getElementById("versions-container");
    const loadMoreBtn = document.getElementById("load-more");

    let offset = 0;
    const limit = 12;

    async function fetchAndRenderVersions() {
        loadMoreBtn.disabled = true;
        loadMoreBtn.textContent = "Cargando...";

        const res = await fetch(`/search/ajax/load_versions/?master_id=${masterId}&offset=${offset}&limit=${limit}`);
        const data = await res.json();

        if (data.versions && data.versions.length) {
            data.versions.forEach(v => {
                const link = document.createElement("a");
                link.href = `/search/record/detail/?release_id=${v.id}`;
                link.classList.add("version-card-link");

                const card = document.createElement("div");
                card.classList.add("version-card");
                card.innerHTML = `
                    <p><strong>A침o:</strong> ${v.year}</p>
                    <p><strong>Pa칤s:</strong> ${v.country}</p>
                    <p><strong>Formato:</strong> ${v.format}</p>
                    <p><strong>Sello:</strong> ${v.label}</p>
                    <p><strong>C칩digo de barras:</strong> ${v.barcode}</p>
                `;
                link.appendChild(card);
                container.appendChild(link);
            });

            offset += limit;
            loadMoreBtn.disabled = false;
            loadMoreBtn.textContent = "Cargar m치s versiones";
        } else {
            loadMoreBtn.style.display = "none";
        }
    }

    loadMoreBtn.addEventListener("click", fetchAndRenderVersions);
    fetchAndRenderVersions();
</script>

{% endblock %}
